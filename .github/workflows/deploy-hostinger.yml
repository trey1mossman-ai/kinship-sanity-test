name: Deploy to Hostinger via Git

on:
  # Trigger on webhook from Sanity (when client publishes content)
  repository_dispatch:
    types: [sanity-publish]

  # Also allow manual trigger from GitHub UI
  workflow_dispatch:

concurrency:
  group: "deploy-prod"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # Full history needed for deploy branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build static site
        run: npm run build
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: u2qzrboc
          NEXT_PUBLIC_SANITY_DATASET: production

      - name: Verify build output exists
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå ERROR: /out directory does not exist!"
            exit 1
          fi
          echo "‚úÖ Build output exists"
          echo "üìä Total files: $(find out -type f | wc -l)"
          echo "üìä Total size: $(du -sh out | cut -f1)"

      - name: Clean state files (remove unnecessary build artifacts)
        run: |
          find out -name '*.build-manifest.json' -delete
          find out -name '*.app-build-manifest.json' -delete
          echo "‚úÖ Cleaned state files"

      - name: Create .htaccess for Hostinger
        run: |
          cat > out/.htaccess << 'EOF'
          # Kinship Landing - Apache Configuration for Hostinger

          # Enable Gzip compression
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/css text/javascript
            AddOutputFilterByType DEFLATE application/javascript application/json
          </IfModule>

          # Handle Next.js static export routing
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Serve existing files and directories as-is
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d

            # For requests without extension, try adding .html
            RewriteCond %{REQUEST_FILENAME}.html -f
            RewriteRule ^(.*)$ $1.html [L]

            # If still not found and it's not a file request, serve index.html
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ /index.html [L]
          </IfModule>

          # Cache static assets
          <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType image/avif "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
          </IfModule>

          # Security headers
          <IfModule mod_headers.c>
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "SAMEORIGIN"
          </IfModule>
          EOF
          echo "‚úÖ .htaccess created with routing and caching rules"

      - name: Deploy to deploy branch
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the out directory to temp location
          echo "üì¶ Saving build output..."
          cp -r out /tmp/out-deploy

          # Fetch and checkout deploy branch
          echo "üîÑ Switching to deploy branch..."
          git fetch origin deploy
          git checkout deploy

          # Remove all files except .git directory
          echo "üßπ Cleaning deploy branch..."
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # Copy new build files
          echo "üìã Copying new build..."
          cp -r /tmp/out-deploy/* .
          cp -r /tmp/out-deploy/.* . 2>/dev/null || true

          # Show what's being deployed
          echo "üìä Files to deploy:"
          ls -la
          echo ""
          echo "Total files: $(find . -type f ! -path './.git/*' | wc -l)"
          echo "Total size: $(du -sh . | cut -f1)"

          # Commit and push
          git add -A
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to deploy"
          else
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Deploy: $TIMESTAMP"
            git push origin deploy
            echo "‚úÖ Successfully deployed to 'deploy' branch"
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "================================================"
          echo "üöÄ DEPLOYMENT COMPLETE"
          echo "================================================"
          echo ""
          echo "üìç Branch: deploy"
          echo "üîó View: https://github.com/trey1mossman-ai/kinship-sanity-test/tree/deploy"
          echo ""
          echo "‚è≥ NEXT STEPS:"
          echo "1. Hostinger will auto-pull within 1-5 minutes"
          echo "2. Check site: https://mediumblue-chamois-837591.hostingersite.com/"
          echo ""
          echo "================================================"
